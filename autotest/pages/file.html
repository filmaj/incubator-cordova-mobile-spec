<!DOCTYPE html>
<html>
<head>
  <title>Cordova: File API Specs</title>

  <meta name="viewport" content="width=device-width, height=device-height, user-scalable=yes, initial-scale=1.0;" />
  <!-- Load jasmine -->
  <link href="../jasmine.css" rel="stylesheet"/>
  <script type="text/javascript" src="../jasmine.js"></script>
  <script type="text/javascript" src="../html/HtmlReporterHelpers.js"></script>
  <script type="text/javascript" src="../html/HtmlReporter.js"></script>
  <script type="text/javascript" src="../html/ReporterView.js"></script>
  <script type="text/javascript" src="../html/SpecView.js"></script>
  <script type="text/javascript" src="../html/SuiteView.js"></script>
  <script type="text/javascript" src="../html/TrivialReporter.js"></script>

  <!-- Source -->
  <script type="text/javascript" src="../../cordova.js"></script>

  <!-- Load Test Runner -->
  <script type="text/javascript" src="../test-runner.js"></script>

  <!-- Tests -->
  <script type="text/javascript" src="../tests/file.tests.js"></script>

  <script type="text/javascript">
      var root, temp_root, persistent_root, num_cb, counting = false;

      function createRemoveWin(name, cb) {
          return function() {
              console.log('[TEST BOOTUP] Removed "' + name + '".');
              num_cb--;
              if (!counting && num_cb === 0) {
                  cb();
              }
          };
      }
      function createRemoveFail(name, cb) {
          return function(err) {
              console.log('[TEST BOOTUP] FAILED removing "' + name + '", error: ' + JSON.stringify(err));
              num_cb--;
              if (!counting && num_cb === 0) {
                  cb();
              }
          };
      }
      function deleteAllTheThings(fs_root, cb) {
          num_cb = 0;
          counting = true;
          var dir = fs_root.createReader();
          dir.readEntries(function(entries) {
              for (var i = 0, l = entries.length; i < l; i++) {
                  var entry = entries[i];
                  if (entry.isFile) {
                      num_cb++;
                      entry.remove(createRemoveWin(entry.name, cb), createRemoveFail(entry.name, cb));
                  } else {
                      fs_root.getDirectory(entry.fullPath, {create:false}, function(dirEntry) {
                          num_cb++;
                          dirEntry.removeRecursively(createRemoveWin(dirEntry.fullPath, cb), createRemoveFail(dirEntry.fullPath, cb));
                      }, function(err) {
                          console.log(['TEST BOOTUP] FAILED retrieving directory for pre-test cleanup, error: ' + JSON.stringify(err));
                      });
                  }
              }
              counting = false;
              if (num_cb === 0) cb();
          }, function(err) {
              console.log(['TEST BOOTUP] FAILED retrieving directory listing for pre-test cleanup, error: ' + JSON.stringify(err));
          });
      }

      document.addEventListener('deviceready', function () {
          // one-time retrieval of the root file system entry
          var onError = function(e) {
              console.log('[ERROR] Problem setting up root filesystem for test running! Error to follow.');
              console.log(JSON.stringify(e));
          };

          window.requestFileSystem(LocalFileSystem.PERSISTENT, 0,
              function(fileSystem) {
                  console.log('File API test Init: Setting PERSISTENT FS.');
                  root = fileSystem.root; // set in file.tests.js
                  persistent_root = root;

                  // First clean out the root
                  console.log('Cleaning up persistent FS before running tests.');
                  deleteAllTheThings(root, function() {
                      window.requestFileSystem(LocalFileSystem.TEMPORARY, 0,
                          function(fileSystem) {
                              console.log('File API test Init: Setting TEMPORARY FS.');
                              temp_root = fileSystem.root; // set in file.tests.js
                              console.log('Cleaning up temporary FS before running tests.');
                              deleteAllTheThings(temp_root, function() { 
                                  // Once root is set up, fire off tests
                                  var jasmineEnv = jasmine.getEnv();
                                  jasmineEnv.updateInterval = 1000;

                                  var htmlReporter = new jasmine.HtmlReporter();

                                  jasmineEnv.addReporter(htmlReporter);

                                  jasmineEnv.specFilter = function(spec) {
                                    return htmlReporter.specFilter(spec);
                                  };
                                  jasmineEnv.execute();
                              });
                          }, onError);
                      });
              }, onError);
      }, false);
  </script>
</head>

<body>
  <a href="javascript:" class="backBtn" onclick="backHome();">Back</a>
</body>
</html>
